# Changelog

All notable changes to this project will be documented in this file.

## [2026-02-18]

### 🚀 AI 모델 업그레이드

#### Gemini 3 Flash Preview 적용
- **파일**: `Services/APIService.swift` - `analyzeIntent()`
- **변경 내용**: 의도 분석 모델을 `gemini-2.0-flash` → **`gemini-3-flash-preview`** 로 업그레이드
- **효과**: 향상된 한국어 대화 맥락 이해, 더 높은 JSON 출력 신뢰도, Thinking 기능 지원으로 복잡한 목적지 추론 정확도 향상
- 입력 토큰 한도 1,048,576 (1M), Structured Output 및 Function Calling 지원

### 🛠 코드 품질 개선 (Refactoring)

#### Swift Concurrency 전면 적용
- `APIService`의 모든 메서드를 `async/await` 패턴으로 전환 (completion handler 제거)
- 중앙화된 `DigitalCaneError` enum 도입으로 통합 에러 처리

#### OverpassService 분리
- `LocationManager`에서 Overpass API 로직 및 Ray Casting 알고리즘을 `OverpassService.swift`로 추출
- 단일 책임 원칙(SRP) 준수 및 모듈성 향상

#### Smart Radius 버그 수정
- `NearbyExploreView`의 스마트 반경 자동 조절 시 디바운싱 로직에 의해 재검색이 차단되던 버그 수정
- **화면 진입 시 반경 값(m)이 리셋되지 않아 자동 조절이 시작되지 않던 문제 수정**: 이제 진입 시 항상 기본값(100m)으로 초기화되어 새로운 자동 조절 사이클이 시작됩니다.
- `forceAutoTune` 파라미터로 디바운싱 우회, 반경 변경 시 즉시 재검색 실행

#### 에러 처리 강화
- `LocationManager`의 `try?` → `do-catch` 전환으로 에러 로깅 개선

### 🌐 국제화 (Localization)
- `NearbyExploreView`, `VoiceCommandModeView`의 사용자 대면 문자열을 `NSLocalizedString`으로 래핑

---

## [2025-12-31]


### 🆕 새로운 기능 (New Features)

#### 1. 선호 교통수단 기반 경로 안내 (Personalized Routing)
- **자연어 의도 파악 강화**: Gemini LLM 프롬프트를 고도화하여 목적지뿐만 아니라 **"버스로 갈래"**, **"지하철로 안내해줘"** 등 사용자가 선호하는 교통수단을 함께 추출합니다.
- **맞춤형 경로 필터링**: 사용자가 선택한 수단(Bus, Subway, Rail 등)을 Google Routes API에 전달하여 해당 수단 위주로 경로를 탐색합니다.

#### 2. 스마트 폴백 가이드 (Smart Fallback Guidance)
- **자동 경로 보정**: 사용자가 요청한 교통수단만으로 이동이 불가능하거나 경로가 없는 경우, 시스템이 이를 감지하여 **자동으로 최적 경로(최단 시간)**를 다시 검색합니다.
- **친절한 음성 안내**: 경로 재검색 시 사용자에게 "요청하신 교통수단으로 이동이 어려워, 최적 경로로 안내합니다."라는 명확한 음성 피드백을 제공하여 혼란을 방지합니다.

#### 3. 무장애 장소 안내 (Accessible Place Guidance)
- **휠체어 접근성 데이터 연동**: Google Places API의 `accessibilityOptions`를 활용하여 턱이 없거나(flat entrance) 휠체어/유모차 진입이 쉬운 장소를 식별합니다.
- **음성 피드백 강화**: '디지털케인' 모드에서 주변 장소를 탐색할 때, 접근성이 좋은 장소는 "입구가 편리합니다"라는 추가 멘트를 제공하여 보행 약자의 편의를 돕습니다.

#### 4. 촉각 나침반 (Tactile Compass)
- **Core Haptics 기반 거리 인지**: 단순 진동을 넘어, 대상과의 거리에 따라 다른 "질감"의 햅틱 피드백을 제공합니다.
  - **10m 이내**: 강하고 둔탁한 진동 (충돌 주의)
  - **10~30m**: 뚜렷하고 선명한 진동 (목표 확인)
  - **30m 이상**: 가볍고 날카로운 진동 (방향 유도)
  - **30m 이상**: 가볍고 날카로운 진동 (방향 유도)
- **비언어적 정보 전달**: 청각 정보에만 의존하지 않고, 손끝의 감각만으로도 공간감을 느낄 수 있도록 UX를 고도화했습니다.

### 5. 스마트 중복 필터링 (Smart De-duplication)
- **데이터 노이즈 제거**: Google Places API 결과 중 이름이 같고 거리가 30m 이내인 장소들을 자동으로 하나로 합쳐서 안내 혼선을 방지했습니다.
- **재안내 로직 개선 (Smart Reset)**:
  - 같은 대상을 계속 가리킬 때는 반복 안내를 억제하여 소음을 줄였습니다.
  - 시야각을 벗어났다가 다시 가리키면(Re-entry) 즉시 다시 안내하여, 사용자가 원할 때 언제든 정보를 다시 확인할 수 있도록 했습니다.

### 🛠 개선 사항 (Improvements)
- `APIService`의 `fetchRoute` 로직을 개선하여 선호 수단 지정 및 Fallback 처리를 위한 파라미터(`preferredModes`, `isFallbackApplied`)를 추가했습니다.
- 경로 검색 실패 시 단순히 에러를 띄우는 대신, 가능한 대안을 찾아 끊김 없는 경험을 제공하도록 UX를 강화했습니다.

---

## [2025-12-30]

### 🔄 주요 업데이트

#### 1. 한국어 문화화 (Culturalization) 및 TTS 개선
- **안내 메시지 수정**: "듣고 있어요" → "듣고 있습니다" 등 전체적인 어조를 더욱 정중하고 자연스럽게 개선했습니다.
- **스마트 조사 처리(Smart Josa)**: MapKit 대중교통경로안내 데이터에도 받침 자동 감지 로직을 적용하여, "2호선**을** 탑승"과 같이 조사가 자연스럽게 연결되도록 했습니다.
- **소요 시간 안내**: 경로 요약 브리핑 시 "총 소요 시간"을 음성으로 함께 안내하도록 기능을 추가했습니다.

#### 2. 사용자 경험 (UX) 최적화
- **탭 리프레시(Tab Refresh)**: 하단 탭을 다시 터치하면 각 기능(주변 탐색, SOS 위치 안내 등)이 즉시 재실행되도록 개선했습니다.
- **탭 전환 시 음성 중단**: 탭을 이동할 때 이전 화면의 음성 안내가 즉시 멈추고 새로운 안내가 시작되도록 로직을 강화했습니다.

#### 3. 기능 및 구조 개선
- **도보 단계 필터링**: 사용자의 요청에 따라 대중교통 경로에서 번거로운 '도보 이동' 상세 단계를 생략하고, 탑승/환승 위주의 핵심 정보만 제공합니다. (대중교통경로안내 최적화)
- **위치 서비스 구조 개선**: `LocationManager`를 앱 전역(`EnvironmentObject`)으로 승격시켜 탭 간 위치 정보 충돌 및 초기화 경합 문제를 해결했습니다.
- **명칭 정밀화**: 메뉴 이름을 '경로 안내'에서 '대중교통경로안내'로 변경하여 기능의 목적을 더 명확하게 정의했습니다. 이에 따라 모든 기술 문서와 연구 문서의 명칭도 일괄 업데이트했습니다.
- **주변 탐색 정밀도 개선**: 현재 사용자가 위치한 건물(POI)을 인식하여 검색 결과에서 자동으로 제외하는 로직을 추가했습니다. (거리 5m 이내 및 명칭 일치 기준)

### 🐛 버그 수정
- `APIService` 및 `ContentView`의 문법 오류 수정.
- 앱 실행 초기 위치 권한 요청 시 발생하던 레이스 컨디션(Race Condition) 프리징 해결.

---

## [2025-12-29]

### 📝 세션 요약
Google Maps API의 한국 데이터 한계를 극복하기 위한 데이터 가공 로직 최적화 및 UX 개선.

### 주요 개선 사항

#### 1. AI 프롬프트 최적화
**파일**: `Services/APIService.swift` - `analyzeIntent()`
- **페르소나 재정의**: "Navigation App" → **"Digital Cane (Mobility Assistant)"**
- **입력 스타일 확장**: 
  - 기존: "서울역으로 가줘" (명령형)
  - 확장: "서울역 가는 법 좀", "어떻게 가?" (대화형/질문형)
- **Hallucination 방지 강화**: "Ask > Guess" 원칙 명시
- **효과**: 자연스러운 한국어 발화 이해율 향상, 모호한 입력 시 명확한 질문 반환

#### 2. POI 검증 로직 강화
**파일**: `Services/NavigationManager.swift` - `findRoute()`
- **변경 내용**: Google Places API 검색 결과 중 행정구역(locality)보다 구체적인 POI(기차역 등)를 우선 선택하도록 필터링 로직 개선.
- **효과**: "용산역" 검색 시 "용산구"가 아닌 "용산역(기차역)"을 정확히 선택.

#### 3. 버스/지하철 정보 정제
**파일**: `Services/APIService.swift` - `convertStep()`
- **구조 개선**: `GTransitVehicle` 구조체 추가 및 한국어 자연화 로직 적용.
- **효과**: "간선버스 143" → **"750B번 버스"**, "지하철 456행" → **"4호선"** 등 한국 실정에 맞는 명칭 표출.

#### 4. 요약 안내 개선
**파일**: `App/ContentView.swift` - `NavigationModeView.announceOverview()`
- **변경 내용**: 출발지/도착지 명시, 주요 교통수단 요약("주요 이동 수단은 750B번 버스입니다"), 안내 톤 변경("경로를 찾았습니다").
- **효과**: 사용자가 전체 경로를 먼저 파악하고 세부 단계를 듣도록 인지 부하 감소.

#### 5. UI 안정성 개선 및 버그 수정
- **List → ScrollView**: 스타일 충돌 제거 및 배경색 명시.
- **LazyVStack → VStack**: 렌더링 안정성 향상.
- **에러 메시지 자연화**: "목적지를 이해하지 못했습니다" → "죄송해요, 목적지를 잘 이해하지 못했습니다. 다시 한 번 말씀해 주시겠어요?"

### 한계 및 향후 개선 방향
1. **Google Maps API 한국 데이터 품질**: 한국 지도법으로 인한 상세 정보 부족 및 실시간 정보 부재.
2. **향후 고려 사항**: 자주 검색되는 경로 로컬 캐싱, 6개월 후 Kakao Local 등 로컬 API 통합 고려.
